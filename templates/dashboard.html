{% extends "base.html" %}
{% from "macros.html" import flash_messages, tooltip, csrf_input %}

{% block html_class %}bg-m3-surface{% endblock %}
{% block title %}DHBW Calendar Cleaner - Dashboard{% endblock %}
{% block body_class %}text-m3-on-surface{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-4 md:p-8">
    <!-- M3 Top App Bar Style Header -->
    <header class="flex flex-wrap items-center justify-between gap-4 pb-4 border-b border-m3-outline-variant">
        <h1 class="text-m3-headline-sm text-m3-on-surface">DHBW Calendar Cleaner</h1>
        <div class="flex items-center gap-4 text-m3-body-md">
            <span class="text-m3-on-surface-variant">Angemeldet als: <strong class="text-m3-on-surface">{{ current_user.data.email }}</strong></span>
            <a href="{{ url_for('logout') }}" 
               class="m3-state-layer inline-flex items-center gap-2 h-10 px-4 rounded-m3-full bg-m3-secondary-container text-m3-on-secondary-container text-m3-label-lg transition-colors duration-m3-short4 ease-m3-standard focus:outline-none focus-visible:ring-2 focus-visible:ring-m3-secondary focus-visible:ring-offset-2">
               <span class="material-symbols-outlined text-[18px]">logout</span>
               <span>Abmelden</span>
            </a>
        </div>
    </header>

    <div class="mt-6">
        {{ flash_messages() }}
    </div>

    <main class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-5">

        <div class="lg:col-span-3 space-y-6">
            
            <!-- M3 Card: Konfiguration -->
            <div class="bg-m3-surface-container p-6 rounded-m3-md">
                <h3 class="text-m3-title-lg text-m3-on-surface mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined">settings</span>
                    Konfiguration
                </h3>
                
                <form action="{{ url_for('save_config') }}" method="POST" class="space-y-5">
                    {{ csrf_input() }}
                    
                    <!-- M3 Outlined Text Field: Source ID -->
                    <div>
                        <label for="source_id" class="flex items-center text-m3-label-lg text-m3-on-surface-variant mb-1">
                            Quell-Kalender ID
                            {{ tooltip('Geben Sie die Google Kalender-ID (z.B. abc@group.calendar.google.com) oder die öffentliche .ics-URL (z.B. https://...) des Quellkalenders an.') }}
                        </label>
                        <input type="text" id="source_id" name="source_id" required value="{{ config.source_id }}"
                               class="m3-text-field w-full bg-transparent text-m3-on-surface">
                    </div>

                    <!-- M3 Outlined Select: Timezone -->
                    <div>
                        <label for="source_timezone" class="flex items-center text-m3-label-lg text-m3-on-surface-variant mb-1">
                            Zeitzone der Quell-Termine
                            {{ tooltip('Wählen Sie die Zeitzone, in der die Termine Ihres Quellkalenders (insb. ICS-Dateien) gemeint sind. Dies korrigiert 1-Stunden-Offsets.') }}
                        </label>
                        <select id="source_timezone" name="source_timezone"
                                class="m3-text-field w-full bg-transparent text-m3-on-surface cursor-pointer">
                            {% for tz in timezones %}
                            <option value="{{ tz.value }}" {% if tz.value == config.source_timezone %}selected{% endif %}>
                                {{ tz.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- M3 Outlined Text Field: Target ID -->
                    <div>
                        <label for="target_id" class="flex items-center text-m3-label-lg text-m3-on-surface-variant mb-1">
                            Ziel-Kalender ID
                            {{ tooltip('Geben Sie die Kalender-ID (aus den Google Kalender-Einstellungen) des Zielkalenders an. Dieser Kalender muss Ihnen gehören und wird bei jedem Sync geleert.') }}
                        </label>
                        <input type="text" id="target_id" name="target_id" required value="{{ config.target_id }}"
                               class="m3-text-field w-full bg-transparent text-m3-on-surface">
                    </div>

                    <!-- M3 Outlined Textarea: Regex Patterns -->
                    <div>
                        <label for="regex_patterns" class="text-m3-label-lg text-m3-on-surface-variant mb-1 block">RegEx Filter-Regeln (eine pro Zeile)</label>
                        <textarea id="regex_patterns" name="regex_patterns" rows="5"
                                  class="m3-text-field w-full bg-transparent text-m3-on-surface font-mono text-m3-body-sm"
                                  placeholder=".*Sport.*&#10;.*Tutorium.*">{{ config.regex_patterns | join('\n') }}</textarea>
                    </div>

                    <!-- M3 Filled Button -->
                    <div>
                        <button type="submit" 
                                class="m3-state-layer inline-flex items-center justify-center gap-2 h-10 px-6 rounded-m3-full bg-m3-primary text-m3-on-primary text-m3-label-lg shadow-m3-elevation-1 hover:shadow-m3-elevation-2 transition-shadow duration-m3-short4 ease-m3-standard focus:outline-none focus-visible:ring-2 focus-visible:ring-m3-primary focus-visible:ring-offset-2">
                            <span class="material-symbols-outlined text-[18px]">save</span>
                            <span>Konfiguration speichern</span>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- M3 Card: Danger Zone -->
            <div class="bg-m3-error-container p-6 rounded-m3-md">
                <h3 class="text-m3-title-lg text-m3-on-error-container flex items-center gap-2">
                    <span class="material-symbols-outlined">warning</span>
                    Gefahrenzone
                </h3>
                <form id="delete-form" action="{{ url_for('delete_account') }}" method="POST">
                    {{ csrf_input() }}
                    <p class="text-m3-body-md text-m3-on-error-container mt-3 mb-4">
                        Wenn Sie Ihr Konto löschen, werden Ihr Authentifizierungs-Token und Ihre gesamte Konfiguration (Quell-, Ziel- und Filterregeln) dauerhaft von unserem Server entfernt. Dies kann nicht rückgängig gemacht werden.
                    </p>
                    <button id="delete-step-1-btn" type="button"
                            class="m3-state-layer inline-flex items-center justify-center gap-2 h-10 px-6 rounded-m3-full bg-m3-error text-m3-on-error text-m3-label-lg shadow-m3-elevation-1 hover:shadow-m3-elevation-2 transition-shadow duration-m3-short4 ease-m3-standard focus:outline-none focus-visible:ring-2 focus-visible:ring-m3-error focus-visible:ring-offset-2">
                        <span class="material-symbols-outlined text-[18px]">delete_forever</span>
                        <span>Konto dauerhaft löschen...</span>
                    </button>
                    <div id="delete-confirmation-box" class="hidden space-y-4 mt-4">
                        <label for="email_confirmation" class="block text-m3-label-lg text-m3-on-error-container">
                            Bitte geben Sie Ihre E-Mail-Adresse (<strong>{{ current_user.data.email }}</strong>) ein, um die Löschung zu bestätigen:
                        </label>
                        <input type="email" id="email_confirmation" name="email_confirmation" required
                               class="w-full bg-m3-surface-container-lowest text-m3-on-surface rounded-m3-xs border border-m3-error px-4 py-3 focus:outline-none focus:ring-2 focus:ring-m3-error"
                               placeholder="{{ current_user.data.email }}">
                        <button type="submit" id="delete-final-btn"
                                class="m3-state-layer w-full inline-flex items-center justify-center gap-2 h-12 px-6 rounded-m3-full bg-m3-error text-m3-on-error text-m3-label-lg shadow-m3-elevation-2 hover:shadow-m3-elevation-3 transition-shadow duration-m3-short4 ease-m3-standard focus:outline-none focus-visible:ring-2 focus-visible:ring-m3-error focus-visible:ring-offset-2">
                            <span class="material-symbols-outlined text-[18px]">delete</span>
                            <span>Ich habe es verstanden, mein Konto LÖSCHEN</span>
                        </button>
                    </div>
                </form>
            </div>

        </div>

        <div class="lg:col-span-2 space-y-6">
            <!-- M3 Card: Live Log -->
            <div class="bg-m3-surface-container p-6 rounded-m3-md">
                <h3 class="text-m3-title-lg text-m3-on-surface flex items-center gap-2">
                    <span class="material-symbols-outlined">terminal</span>
                    Live-Log
                </h3>
                <p class="text-m3-body-sm text-m3-on-surface-variant mt-1 mb-4">Der automatische Sync läuft stündlich.</p>
                
                <!-- M3 Segmented Button Style Actions -->
                <div class="relative mb-4">
                    <div class="flex rounded-m3-full shadow-m3-elevation-1 overflow-hidden">
                        <form action="{{ url_for('sync_now') }}" method="POST" class="flex-1">
                            {{ csrf_input() }}
                            <button type="submit"
                                    class="m3-state-layer w-full h-10 bg-m3-secondary-container text-m3-on-secondary-container text-m3-label-lg transition-colors duration-m3-short4 ease-m3-standard focus:outline-none focus-visible:ring-2 focus-visible:ring-m3-secondary focus-visible:ring-offset-2 flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-[18px]">sync</span>
                                <span>Manuellen Sync starten</span>
                            </button>
                        </form>
                        <button type="button" id="quick-actions-toggle"
                                class="m3-state-layer bg-m3-secondary text-m3-on-secondary px-4 transition-colors duration-m3-short4 ease-m3-standard focus:outline-none focus-visible:ring-2 focus-visible:ring-m3-secondary focus-visible:ring-offset-2">
                            <span class="sr-only">Weitere Aktionen</span>
                            <span class="material-symbols-outlined text-[18px]">expand_more</span>
                        </button>
                    </div>
                    
                    <!-- M3 Menu -->
                    <div id="quick-actions-menu"
                         class="hidden absolute right-0 z-10 mt-2 w-72 rounded-m3-xs bg-m3-surface-container-low py-2 shadow-m3-elevation-2">
                        <form action="{{ url_for('sync_now') }}" method="POST" data-quick-action="true">
                            {{ csrf_input() }}
                            <button type="submit"
                                    class="m3-state-layer flex w-full items-center gap-3 px-4 py-3 text-m3-body-md text-m3-on-surface hover:bg-m3-surface-container">
                                <span class="material-symbols-outlined text-m3-on-surface-variant">sync</span>
                                <span>Manuellen Sync jetzt ausführen</span>
                            </button>
                        </form>
                        <form action="{{ url_for('clear_sync_cache') }}" method="POST" data-quick-action="true" data-confirm="Der Sync-Cache wird geleert. Der nächste Sync synchronisiert alle Events neu. Fortfahren?">
                            {{ csrf_input() }}
                            <button type="submit"
                                    class="m3-state-layer flex w-full items-center gap-3 px-4 py-3 text-m3-body-md text-m3-on-surface hover:bg-m3-surface-container">
                                <span class="material-symbols-outlined text-m3-on-surface-variant">cached</span>
                                <span>Sync-Cache leeren (Full-Sync erzwingen)</span>
                            </button>
                        </form>
                        <div class="border-t border-m3-outline-variant my-1"></div>
                        <form action="{{ url_for('wipe_target_calendar') }}" method="POST" data-quick-action="true" data-confirm="Alle Einträge im Zielkalender werden gelöscht. Fortfahren?">
                            {{ csrf_input() }}
                            <button type="submit"
                                    class="m3-state-layer flex w-full items-center gap-3 px-4 py-3 text-m3-body-md text-m3-error hover:bg-m3-error-container">
                                <span class="material-symbols-outlined">delete_sweep</span>
                                <span>Alle Einträge im Zielkalender löschen</span>
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Log Output -->
                <div id="log-box-content" 
                     class="h-96 overflow-y-scroll rounded-m3-sm bg-m3-inverse-surface p-4 font-mono text-m3-body-sm text-m3-inverse-on-surface break-words">
                    {% for line in logs %}
                        {{ line }}<br>
                    {% endfor %}
                </div>
            </div>
        </div>

    </main>
</div>
{% endblock %}

{% block footer %}
<footer class="text-center text-xs text-gray-500 py-6 space-y-1 border-t border-gray-200 mt-8 max-w-7xl mx-auto">
    <div class="flex justify-center gap-4 mb-1">
        <a href="{{ url_for('privacy_policy') }}" class="font-medium text-blue-600 hover:underline">Datenschutz</a>
        <a href="{{ url_for('terms_of_service') }}" class="font-medium text-blue-600 hover:underline">Nutzungsbedingungen</a>
    </div>
    <p>
        Mehr Projekte findest du bei 
        <a href="https://thulium-labs.de" target="_blank" rel="noopener" class="font-medium text-blue-600 hover:underline">thulium-labs.de</a>.
    </p>
    <p>Made by Tobias Maimone</p>
</footer>
{% endblock %}

{% block scripts %}
<script>
    (function() {
        const quickToggle = document.getElementById('quick-actions-toggle');
        const quickMenu = document.getElementById('quick-actions-menu');

        const hideQuickMenu = () => {
            if (quickMenu && !quickMenu.classList.contains('hidden')) {
                quickMenu.classList.add('hidden');
            }
        };

        if (quickToggle && quickMenu) {
            quickToggle.addEventListener('click', function (event) {
                event.preventDefault();
                quickMenu.classList.toggle('hidden');
            });

            document.addEventListener('click', function (event) {
                if (!quickMenu || quickMenu.classList.contains('hidden')) {
                    return;
                }
                if (!quickMenu.contains(event.target) && !quickToggle.contains(event.target)) {
                    hideQuickMenu();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    hideQuickMenu();
                }
            });
        }

        const quickActionForms = document.querySelectorAll('form[data-quick-action="true"]');
        quickActionForms.forEach(form => {
            form.addEventListener('submit', async function (event) {
                event.preventDefault();

                if (form.dataset.confirm) {
                    const confirmed = window.confirm(form.dataset.confirm);
                    if (!confirmed) {
                        hideQuickMenu();
                        return;
                    }
                }

                const formData = new FormData(form);

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'fetch'
                        }
                    });

                    let payload = null;
                    try {
                        payload = await response.json();
                    } catch (error) {
                        payload = null;
                    }

                    hideQuickMenu();

                    if (response.ok && payload && payload.status === 'ok') {
                        const redirectUrl = payload.redirect || "{{ url_for('index') }}";
                        window.location.href = redirectUrl;
                    } else {
                        const message = payload && payload.message ? payload.message : 'Aktion fehlgeschlagen.';
                        alert(message);
                    }
                } catch (error) {
                    hideQuickMenu();
                    alert('Aktion konnte nicht ausgeführt werden: ' + error);
                }
            });
        });

        // --- Live-Log Polling ---
        const logBox = document.getElementById('log-box-content');
        if (logBox) {
            let isPolling = true;
            let pollInterval = 5000;

            async function fetchLogs() {
                if (!isPolling) return;
                try {
                    const response = await fetch("{{ url_for('get_logs') }}");
                    if (!response.ok) {
                        logBox.innerHTML = '<span class="text-red-300">Fehler beim Laden der Logs (HTTP ' + response.status + ')</span>';
                        return;
                    }
                    const data = await response.json();
                    logBox.innerHTML = data.logs.map(line => `<span>${line}</span>`).join('<br>');
                    logBox.scrollTop = logBox.scrollHeight;
                } catch (e) {
                    logBox.innerHTML = '<span class="text-red-300">Verbindungsfehler beim Laden der Logs: ' + e + '</span>';
                    isPolling = false;
                }
            }
            fetchLogs();
            setInterval(fetchLogs, pollInterval);
        }

        // --- Konto löschen Logik ---
        const deleteBtn = document.getElementById('delete-step-1-btn');
        const deleteConfirmBox = document.getElementById('delete-confirmation-box');
        const deleteForm = document.getElementById('delete-form');
        const deleteFinalBtn = document.getElementById('delete-final-btn');
        const emailInput = document.getElementById('email_confirmation');
        const userEmail = "{{ current_user.data.email }}";

        if (deleteBtn && deleteConfirmBox) {
            deleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                deleteBtn.classList.add('hidden'); 
                deleteConfirmBox.classList.remove('hidden');
                emailInput.focus();
            });
        }

        if (deleteFinalBtn && deleteForm && emailInput) {
            deleteForm.addEventListener('submit', function(e) {
                // Prüfe ob E-Mail eingegeben wurde
                const enteredEmail = emailInput.value.trim();
                if (!enteredEmail) {
                    e.preventDefault();
                    alert('Bitte geben Sie Ihre E-Mail-Adresse ein, um die Löschung zu bestätigen.');
                    emailInput.focus();
                    return false;
                }
                
                // Prüfe ob E-Mail korrekt ist
                if (enteredEmail !== userEmail) {
                    e.preventDefault();
                    alert('Die eingegebene E-Mail-Adresse stimmt nicht überein.');
                    emailInput.focus();
                    return false;
                }
                
                // Zeige finale Bestätigung
                if (!confirm('Sind Sie absolut sicher? Diese Aktion kann nicht rückgängig gemacht werden.')) {
                    e.preventDefault();
                    return false;
                }
                
                return true;
            });
        }

        // --- Tooltip Klick-Logik ---
        document.querySelectorAll('.tooltip-trigger').forEach(function(trigger) {
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Schließe alle anderen Tooltips
                document.querySelectorAll('.tooltip-content').forEach(function(tip) {
                    if (tip !== trigger.nextElementSibling) {
                        tip.classList.add('hidden');
                    }
                });
                
                // Toggle diesen Tooltip
                const tooltip = trigger.nextElementSibling;
                tooltip.classList.toggle('hidden');
            });
        });
        
        // Schließe Tooltips bei Klick außerhalb
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.tooltip-wrapper')) {
                document.querySelectorAll('.tooltip-content').forEach(function(tip) {
                    tip.classList.add('hidden');
                });
            }
        });

        // --- Auto-Detect Timezone from ICS ---
        const sourceIdInput = document.getElementById('source_id');
        const timezoneSelect = document.getElementById('source_timezone');
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        let lastDetectedUrl = '{{ config.source_id }}';
        let userManuallyChangedTimezone = false;
        
        // Merke wenn User manuell die Zeitzone ändert
        if (timezoneSelect) {
            timezoneSelect.addEventListener('change', function() {
                userManuallyChangedTimezone = true;
            });
        }
        
        if (sourceIdInput && timezoneSelect) {
            // Debounce-Funktion um nicht bei jedem Tastendruck zu fetchen
            let debounceTimer;
            
            sourceIdInput.addEventListener('input', function() {
                const url = sourceIdInput.value.trim();
                
                // Nur für URLs und wenn geändert
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    return;
                }
                
                if (url === lastDetectedUrl) {
                    return;
                }
                
                // Reset manual flag wenn URL sich ändert
                userManuallyChangedTimezone = false;
                
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async function() {
                    try {
                        const formData = new FormData();
                        formData.append('url', url);
                        formData.append('csrf_token', csrfToken);
                        
                        const response = await fetch("{{ url_for('detect_timezone') }}", {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) return;
                        
                        const data = await response.json();
                        
                        if (data.timezone && !userManuallyChangedTimezone) {
                            // Setze erkannte Zeitzone als Auswahl
                            const option = timezoneSelect.querySelector(`option[value="${data.timezone}"]`);
                            if (option) {
                                timezoneSelect.value = data.timezone;
                                lastDetectedUrl = url;
                                
                                // Kurzes visuelles Feedback
                                timezoneSelect.style.borderColor = '#1e8e3e';
                                setTimeout(() => {
                                    timezoneSelect.style.borderColor = '';
                                }, 2000);
                            }
                        }
                    } catch (e) {
                        // Fehler still ignorieren
                    }
                }, 800); // 800ms Debounce
            });
        }
    })();
</script>
{% endblock %}